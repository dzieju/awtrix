blueprint:
  name: Awtrix – Wyświetlanie danych z encji (sensor/weather)
  description: >
    Publikuje wartość encji (lub atrybutu temperature dla weather) do AWtrix przez MQTT
    z konfigurowalną ikoną, liczbą powtórzeń, czcionką, sufiksem i opcjami tekstu (wielkie litery / brak przewijania).
  domain: automation
  input:
    sensor_entity:
      name: Encja źródłowa (entity_id)
      description: Wpisz entity_id encji (np. sensor.lazienka_temperature lub weather.forecast_dom).
                   Możesz skorzystać z autocomplete w UI przy tworzeniu automatyzacji.
      selector:
        text:
          multiline: false
    awtrix_topic:
      name: Temat MQTT
      description: Temat MQTT dla Twojego urządzenia AWtrix (np. awtrix_664dc4/custom/sypialnia)
      selector:
        text:
          multiline: false
    suffix:
      name: Sufiks (co dopisać po wartości)
      description: Tekst dopisywany po wartości (np. "°C", "%", " km/h"). Pozostaw puste, aby nie dodawać nic.
      default: "°C"
      selector:
        text:
          multiline: false
    icon_id:
      name: ID ikony
      description: Numer ikony AWtrix (np. 1447). Można też wpisać tekstowy identyfikator.
      default: 1447
      selector:
        number:
          min: 0
          max: 99999
    push_icon:
      name: pushIcon
      description: Wartość pushIcon (0 = nie nadpisuj, 2 = nadpisz)
      default: 2
      selector:
        number:
          min: 0
          max: 2
          mode: slider
    repeat_count:
      name: Liczba powtórzeń
      description: Ile razy ma się wyświetlić komunikat
      default: 1
      selector:
        number:
          min: 1
          max: 10
    uppercase:
      name: Wielkie litery
      description: Czy tekst ma być pisany wielkimi literami
      default: true
      selector:
        boolean: {}
    no_scroll:
      name: Bez przewijania
      description: Czy tekst ma być statyczny (bez przewijania)
      default: false
      selector:
        boolean: {}
    font_id:
      name: ID czcionki
      description: Numer czcionki AWtrix (np. 0 = domyślna)
      default: 0
      selector:
        number:
          min: 0
          max: 10

variables:
  sensor_entity: !input sensor_entity
  awtrix_topic: !input awtrix_topic
  suffix: !input suffix
  icon_id: !input icon_id
  push_icon: !input push_icon
  repeat_count: !input repeat_count
  uppercase: !input uppercase
  no_scroll: !input no_scroll
  font_id: !input font_id

trigger:
  - platform: state
    entity_id: !input sensor_entity

action:
  - service: mqtt.publish
    data:
      topic: !input awtrix_topic
      retain: false
      payload: >
        {% set raw = state_attr(sensor_entity, 'temperature') if state_attr(sensor_entity, 'temperature') is not none else states(sensor_entity) %}
        {% set num = raw | float(default=None) %}
        {% if raw in ['unknown','unavailable','', none] %}
          {% set text = 'N/A' %}
        {% elif num is not none %}
          {% set text = (num | round(1)) ~ (suffix | default('°C')) %}
        {% else %}
          {% set text = raw %}
        {% endif %}
        {{ {
            'text': text,
            'icon': icon_id,
            'pushIcon': push_icon,
            'repeat': repeat_count,
            'noScroll': no_scroll,
            'uppercase': uppercase,
            'font': font_id
           } | tojson }}

mode: restart
